<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity3"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet">
	<!-- Font Awesome 6 Free (Latest) -->
		<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<th:block th:include="fragments/headerlibs.html :: headerlibs"></th:block> 

<body id="page-top" onload="getSupportTicketListList()" >
	
<div class="bs-canvas-overlay bg-dark position-fixed w-100 h-100"></div>
<!-- Page Wrapper -->
<div id="wrapper">
    <!-- Sidebar -->
    <div th:insert="fragments/sidenav.html :: sidevav"></div>
    <!-- End of Sidebar -->
    <!-- Content Wrapper -->
    <div id="content-wrapper" class="d-flex flex-column">
        <!-- Main Content -->
        <div id="content">
        <!-- Topbar -->
		<nav class="navbar navbar-expand navbar-light bg-white topbar static-top">

           <!-- Topbar Navbar -->
           <ul class="navbar-nav top-nav">

           </ul>

		   <!-- Right Icons + Profile -->
		    <ul class="navbar-nav d-flex flex-row align-items-center mb-0">
		      <!-- Wallet Icon -->
		    
			  <li class="nav-item mr-3" th:switch="${session.user_role}">
		        <a th:case="2" role="button">
		          <img src="img/Wallet-icon.png" alt="Wallet" class="nav-icon-img" >
		        </a>
				<a th:case="*" href="/cotowallet" role="button">
		          <img src="img/Wallet-icon.png" alt="Wallet" class="nav-icon-img" >
		        </a>
		      </li>
		      <!-- Notification Icon -->
		      <li class="nav-item mr-3">
		        <a href="#" role="button">
		          <img src="img/Notification-icon.png" alt="Notification" class="nav-icon-img">
		        </a>
		      </li>

		      <!-- Profile Dropdown -->
		      <li class="nav-item dropdown no-arrow">
		        <a class="nav-link dropdown-toggle p-0" href="#" id="userDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
		          <img class="img-profile rounded-circle" src="img/undraw_profile.svg" alt="User" style="width: 32px; height: 32px;">
		        </a>
		        <div class="dropdown-menu dropdown-menu-right shadow animated--grow-in" aria-labelledby="userDropdown">
		          <a class="dropdown-item" href="/ProfileInfo">
		            <i class="fas fa-user fa-sm fa-fw mr-2 text-gray-400"></i> Profile
		          </a>
		       <!--   <a class="dropdown-item" href="#">
		            <i class="fas fa-cogs fa-sm fa-fw mr-2 text-gray-400"></i> Settings
		          </a>-->
		          <div class="dropdown-divider"></div>
		          <a class="dropdown-item" href="/logout">
		            <i class="fas fa-sign-out-alt fa-sm fa-fw mr-2 text-gray-400"></i> Logout
		          </a>
		        </div>
		      </li>
		    </ul>	
       </nav>
     <!-- End of Topbar -->
         <!-- Begin Page Content -->
		 <div class="container-fluid p-0 p-md-1 mt-4">
		    <div class="row">
		      <div class="col-12 col-md-12 px-4">

		        <div class="d-flex justify-content-between align-items-center mb-3">
		          <h4 class="fw-bold">Support</h4>
		          <div>
					<!--<button class="btn btn-custom me-2" data-bs-toggle="modal" data-bs-target="#AddVehicleModal">
		              <i class="bi bi-plus-lg"></i> Raise Ticket
		            </button>-->
					<button class="btn btn-custom me-2"  type="button" id="raiseTicket">
		              <i class="bi bi-plus-lg"></i> Raise Ticket
		            </button>
		 
		          </div>
		        </div>				       
		          <div class="table-responsive">
		            <table class="table table-reimbursements mb-0" id="supportTicketList">
						<thead>
		                <tr>		
		                  <th>Ticket No.</th>	  
						  <th>Subject</th>
						 <th>Ticket Date&Time</th>
						 <th>Status</th>
						 <!--<th>Current Status</th>-->
						 <th>Chat History</th>
		                </tr>
		              </thead>
		              <tbody class="table-bordered">
						<!--<tr>			 
							 <td>
					           5788904854
					         </td>
							 
							 <td>Wrong validity date</td>
							 <td>08-07-2025<br>4:00 Pm</td>
							 <td>Active</td>
							 <td>Response awaited</td>
							 <td>
							   <a href="#" class="view-voucher-details">
							     <img src="img/history-icon.png" alt="History Icon" style="height:24px; width:24px; margin-right:4px;">
							     Chat with Customer Success Team
							   </a>
							 </td>
			                </tr>
							<tr>													 
								 <td>
						           5788904854
						         </td>
								 
								 <td>Wrong validity date</td>
								 <td>08-07-2025<br>4:00 Pm</td>
								 <td>Active</td>
								 <td>Respond to message </td>
								 <td>
								   <a href="#" class="view-voucher-details">
								     <img src="img/history-icon.png" alt="History Icon" style="height:24px; width:24px; margin-right:4px;">
								     Chat with Customer Success Team
								   </a>
								 </td>
				                </tr>
								
								<tr>
								 <td>
						           4755001323
						         </td>
								 <td>Net issue while redemption</td>
								 <td>03-07-2025<br>8:00 Pm</td>
								 <td>Closed</td>
								 <td>Closed</td>
								 <td>
								   <a href="#" class="view-voucher-details">
								     <img src="img/history-icon.png" alt="History Icon" style="height:24px; width:24px; margin-right:4px;">
								     Chat with Customer Success Team
								   </a>
								 </td>
				                </tr>-->
		              </tbody>
		            </table>
		          </div>
		        </div>

		      </div>
		    </div>
			<!-- All inline styles replaced with unique CSS classes -->
			<!-- Modal Wrapper -->
			<div class="voucher-modal-overlay voucher-modal-overlay--dark" id="modal-overlay">
			  <div class="voucher-modal-canvas" id="bs-canvas-right1" style="position: fixed; right: -378px; top: 0; height: 100%; width: 378px; background: #fff; transition: right 0.3s ease-in-out; z-index: 1050; box-shadow: -2px 0 6px rgba(0, 0, 0, 0.2);">
			    <div class="voucher-modal-scrollable-wrapper" style="display: flex; flex-direction: column; height: 100%;">

			      <!-- Header -->
			      <div class="voucher-header">
			        <h5 class="voucher-title">Chat with Cotodel Admin</h5>
			        <button class="voucher-close-btn bs-canvas-close" aria-label="Close">
			          <i class="fas fa-times voucher-close-icon"></i>
			        </button>
			      </div>

			      <!-- Chat Area -->
				  <div class="voucher-modal-scrollable" id="chat-box">
				      <!--<div class="chat-msg admin-msg">
				        <p>Hello! How can I help you today?</p>
				        <span class="chat-timestamp">10:00 AM</span>
				      </div>

				      <div class="chat-gap"></div>

				      <div class="chat-msg user-msg">
				        <p>I have an issue with my last ticket.</p>
				        <span class="chat-timestamp">10:01 AM</span>
				      </div>

				      <div class="chat-gap"></div>

				      <div class="chat-msg admin-msg">
				        <p>Can you please elaborate on the issue?</p>
				        <span class="chat-timestamp">10:02 AM</span>
				      </div>

				      <div class="chat-gap"></div>

				      <div class="chat-msg user-msg">
				        <p>The ticket was marked as resolved but the issue still persists.</p>
				        <span class="chat-timestamp">10:03 AM</span>
				      </div>

				      <div class="chat-gap"></div>

				      <div class="chat-msg admin-msg">
				        <p>Hello! How can I help you today?</p>
				        <span class="chat-timestamp">10:04 AM</span>
				      </div>

				      <div class="chat-gap"></div>

				      <div class="chat-msg user-msg">
				        <p>I have an issue with my last ticket.</p>
				        <span class="chat-timestamp">10:05 AM</span>
				      </div>

				      <div class="chat-gap"></div>

				      <div class="chat-msg admin-msg">
				        <p>Can you please elaborate on the issue?</p>
				        <span class="chat-timestamp">10:06 AM</span>
				      </div>

				      <div class="chat-gap"></div>

				      <div class="chat-msg user-msg">
				        <p>The ticket was marked as resolved but the issue still persists.</p>
				        <span class="chat-timestamp">10:07 AM</span>
				      </div>-->
				    </div>

			      <!-- Input Area -->
				  <div class="chat-input-bar">
					
				    <label for="chatFileUpload" class="chat-attachment-label">
				      <i class="fas fa-paperclip"></i>
				      <input type="file" id="chatFileUpload"  accept="image/*" onchange="convertImageToBase641()"  hidden>
				    </label>
				    <input type="text" id="chatInput" class="chat-input" placeholder="Type a message..." >
				    <button id="sendChatBtn" class="chat-send-btn" onclick="customerReplyTicket()">Send</button>
				  </div>
				  <label id="showFileName"></label>
				  <div class="error-msg" id="fileInputError" ></div>	 	
			    </div>
			  </div>
			</div>
	
			
			<!-- All inline styles replaced with unique CSS classes -->
					<!-- Modal Wrapper -->
					<div class="voucher-modal-overlay voucher-modal-overlay--dark" id="modal-overlay2">
					  <div class="voucher-modal-canvas" id="bs-canvas-right2" style="position: fixed; right: -378px; top: 0; height: 100%; width: 378px; background: #fff; transition: right 0.3s ease-in-out; z-index: 1050; box-shadow: -2px 0 6px rgba(0, 0, 0, 0.2);">
					    <div class="voucher-modal-scrollable-wrapper" style="display: flex; flex-direction: column; height: 100%;">

					      <!-- Header -->
					      <div class="voucher-header mt-3">
					        <h5 class="voucher-title" style="margin-left: 10px;">Submit Ticket</h5>
					        <button class="voucher-close-btn bs-canvas-close2" aria-label="Close">
					          <i class="fas fa-times voucher-close-icon"></i>
					        </button>
					      </div>

					      <!-- Chat Area -->
						  <div class="voucher-modal-scrollable" id="chat-box">
							<form class="w-100">
													 <div class="did-floating-label-content mb-3">
												           <input 
												             type="text"
												             id="subject"
												             class="did-floating-input"
												             placeholder="" style="text-transform: uppercase;"
												             maxlength="100" >
												           <label class="did-floating-label">Subject</label>
												         </div>
													 <div class="error-msg" id="subjectError" style="margin-top: -10px; font-size: 12px;"></div>
													 
													 <div class="did-floating-label-content mb-3">
														<textarea
														  id="message"
														  class="did-floating-input"
														  placeholder=""
														  style="height: 100px; resize: vertical; vertical-align: top; padding-top: 8px;"
														></textarea>
							 					           <label class="did-floating-label">Message</label>
							 					         </div>
														 <div class="error-msg" id="messageError" style=" margin-top: -10px; font-size: 12px;"></div>
													 <!-- File Upload Field -->
													 <div class="did-floating-label-content mb-3">
													   <label for="fileUpload" style="font-size: 14px; margin-bottom: 5px;">Attach File</label>
													   <input type="file" id="up" class="form-control" accept="image/*"  onchange="convertImageToBase64()" 
													  >
													 </div>
												     <div class="d-grid">
													 <div class="error-msg" id="fileInputError1" style="color: red; margin-top: -10px; font-size: 12px;"></div>	 
													 						  
													 <!--<button type="button" class="chat-send-btn w-100" 
														 style="background-color:  #367AFF;border-radius: 10px;padding: 10px 0;" onclick="saveTicket()">
									                         Submit Ticket
									                     </button>-->
														 <!--<button id="sendChatBtn" class="chat-send-btn" onclick="replyTicket()">Send</button>
												  -->   </div>
												   </form>  
						    </div>
							
					      <!-- Input Area -->
						<!--  <div class="chat-input-bar">
						    <label for="chatFileUpload" class="chat-attachment-label">
						      <i class="fas fa-paperclip"></i>
						      <input type="file" id="chatFileUpload" hidden>
						    </label>
						    <input type="text" id="chatInput" class="chat-input" placeholder="Type a message...">
						    <button id="sendChatBtn" class="chat-send-btn" onclick="replyTicket()">Send</button>
						  </div>-->

					    </div>
						<button type="button" class="chat-send-btn " id="customerTicketSubmit"
						 style="background-color:  #367AFF;border-radius: 10px;padding: 10px 0;max-width: 360px;margin-left: 10px;" onclick="saveTicket()">
	                         Submit Ticket
	                     </button>
					  </div>
					</div>
					
			 <!-- add vehicle modal-->
			 <div class="modal fade" id="AddVehicleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
			     <div class="modal-dialog modal-dialog-centered modal-approval-wrap" role="document">
			         <div class="modal-content modal-bulk1" style="height: 450px !important;">
			             <div class="modal-header pb-0">
			                 <h5 class="modal-title mx-auto fw-dark text-left w-100" id="exampleModalCenterTitle">Ticket</h5>
			                 <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="closeexampleModalCenterTitle()">
			                     <span aria-hidden="true">×</span>
			                 </button>
			             </div>
						 <div class="modal-body px-4">
						   <form class="w-100">
							 <div class="did-floating-label-content mb-3">
 					           <input 
 					             type="text"
 					             id="subject"
 					             class="did-floating-input"
 					             placeholder="" style="text-transform: uppercase;"
 					             maxlength="100" >
 					           <label class="did-floating-label">Subject</label>
 					         </div>
							 <div class="error-msg" id="subjectError" style="margin-top: -10px; font-size: 12px;"></div>
							 
							 <div class="did-floating-label-content mb-3">
								<textarea
								  id="message"
								  class="did-floating-input"
								  placeholder=""
								  style="height: 100px; resize: vertical; vertical-align: top; padding-top: 8px;"
								></textarea>
  					           <label class="did-floating-label">Message</label>
  					         </div>
 							 <div class="error-msg" id="messageError" style=" margin-top: -10px; font-size: 12px;"></div>
							 <!-- File Upload Field -->
							 <div class="did-floating-label-content mb-3">
							   <label for="fileUpload" style="font-size: 14px; margin-bottom: 5px;">Attach File</label>
							   <input type="file" id="up" class="form-control" accept=".jpg, .jpeg, .png" onchange="convertImageToBase64()" />
							 </div>
						     <div class="d-grid">
							 <div class="error-msg" id="fileInputError" style="color: red; margin-top: -10px; font-size: 12px;"></div>	 
							 						  
							 <button type="button" class="btn btn-primary w-100" 
 							 style="background-color:  #367AFF;border-radius: 10px;padding: 10px 0;" onclick="saveTicket()">
 		                         Submit Ticket
 		                     </button>
							 
						     </div>
						   </form>
						 </div>
						
			         </div>
			     </div>
			 </div>
			
		
		<!-- Vehicle Details Modal -->		  								
					 <div class="lds-spinner" id="signinLoader" style="display: none">
						<div></div>
						<div></div>
						<div></div>
						<div></div>
						<div></div>
						<div></div>
						<div></div>
						<div></div>
						<div></div>
						<div></div>
						<div></div>
						<div></div>
					</div>

                </div>
                <!-- /.container-fluid -->
				<input type="hidden" class="form-input" id="employerId" name="employerId" th:value="${session.id}"> 	
				<input type="hidden" class="form-input" id="employerName" name="employerName" th:value="${session.username}"> 
				<input type="hidden" class="form-input" id="createdBy" name="createdBy" th:value="${session.username}">
				<input type="hidden" class="form-input" id="employerMobile" name="employerMobile" th:value="${session.mobile}">								
				<input type="hidden" class="form-input" id="base64Output" name="base64Output"> 
				<input type="hidden" class="form-input" id="currstatus" name="currstatus">
				<input type="hidden" class="form-input" id="currstatusDesc" name="currstatusDesc">
				<input type="hidden" class="form-input" id="fileName" name="fileName">
				<input type="hidden" id="ticketId" name="ticketId" value=""/> 
			
            </div>
            <!-- End of Main Content -->
        </div>
        <!-- End of Content Wrapper -->

    </div>
    <!-- End of Page Wrapper -->

    <div id="bs-canvas-right" class="bs-canvas bs-canvas-right position-fixed bg-white h-100">
        <button type="button" class="bs-canvas-close float-right test" aria-label="Close" aria-expanded="false"><span aria-hidden="true">&times;</span></button>
       
    <!-- Scroll to Top Button-->
    <a class="scroll-to-top rounded" href="#page-top">
        <i class="fas fa-angle-up"></i>
    </a>

    <!-- Bootstrap core JavaScript-->
    <script src="vendor/jquery/jquery.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Core plugin JavaScript-->
    <script src="vendor/jquery-easing/jquery.easing.min.js"></script>

    <!-- Custom scripts for all pages-->
    <script src="js/sb-admin-2.min.js"></script>

    <!-- Page level plugins -->
    <script src="vendor/datatables/jquery.dataTables.min.js"></script>
    <script src="vendor/datatables/dataTables.bootstrap4.min.js"></script>

    <!-- Page level custom scripts -->
    <script src="js/demo/datatables-demo.js"></script>
    <script type="text/javascript" src="cotodel-js/ticket-support.js"></script>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
	
   <script>
	
	
     // Hide dropdown when clicking outside
     document.addEventListener('click', function (event) {
       document.querySelectorAll('.search-select-wrapper').forEach(wrapper => {
         if (!wrapper.contains(event.target)) {
           const box = wrapper.querySelector('.suggestion-box');
           if (box) box.style.display = 'none';
         }
       });
     });
   </script>

	<script>					  					 
		  function toggleSection(contentId, iconId) 
		  {
		     const content = document.getElementById(contentId);
		     const icon = document.getElementById(iconId);

		     const isVisible = content.style.display === 'flex' || content.style.display === '';

		     content.style.display = isVisible ? 'none' : 'flex';
		     icon.classList.toggle('rotate', !isVisible);
		   }
	</script>
	<script>	

function openModalConfirm() {
	const vehicleDetailsModal = document.getElementById('vehicleDetailsModal');
	vehicleDetailsModal.style.display = 'none';
	const modal = document.getElementById('ModalConfirm');
	modal.style.display = 'block';

	  // Create backdrop manually if needed
	  if (!document.querySelector('.modal-backdrop')) {
	    const backdrop = document.createElement('div');
	    backdrop.className = 'modal-backdrop fade show';
	    document.body.appendChild(backdrop);
	  }
	  // Lock body scroll
	  document.body.classList.add('modal-open');
	}
	
	function closeAdd(){	
		const vehicleDetailsModal = document.getElementById('vehicleDetailsModal');
		vehicleDetailsModal.style.display = 'none';
	}
	function closeexampleModalCenterTitle(){
		/*const vehicleDetailsModal = document.getElementById('AddVehicleModal');
		vehicleDetailsModal.style.display = 'none';*/
		const modal = $('#AddVehicleModal');

		// Bootstrap hide modal properly
		modal.modal('hide');

		// Remove remaining backdrop if needed (fail-safe)
		$('.modal-backdrop').remove();

		// Remove modal-open class from body (fail-safe)
		$('body').removeClass('modal-open').css('padding-right', '');
	}
	function closeHistory(){
		const vehicleHistoryModal = document.getElementById('vehicleHistoryModal');
		vehicleHistoryModal.style.display = 'none';
	}
	
	function closeModalConfirmUpdate(){
		const modalConfirmUpdate = document.getElementById('ModalConfirmUpdate');
			modalConfirmUpdate.style.display = 'none';
	}
	function editDetailsModalClose(){
		const editDetailsModal = document.getElementById('editDetailsModal');
		editDetailsModal.style.display = 'none';
				
	}

</script>

    <script>
        jQuery(document).ready(function($){
            var bsOverlay = $('.bs-canvas-overlay');
            $('[data-toggle="canvas"]').on('click', function(){
                var ctrl = $(this), 
                    elm = ctrl.is('button') ? ctrl.data('target') : ctrl.attr('href');
                $(elm).addClass('mr-0');
                $(elm + ' .bs-canvas-close').attr('aria-expanded', "true");
                $('[data-target="' + elm + '"], a[href="' + elm + '"]').attr('aria-expanded', "true");
                if(bsOverlay.length)
                    bsOverlay.addClass('show');
                return false;
            });
            
            $('.bs-canvas-close, .bs-canvas-overlay').on('click', function(){
                var elm;
                if($(this).hasClass('bs-canvas-close')) {
                    elm = $(this).closest('.bs-canvas');
                    $('[data-target="' + elm + '"], a[href="' + elm + '"]').attr('aria-expanded', "false");
                } else {
                    elm = $('.bs-canvas')
                    $('[data-toggle="canvas"]').attr('aria-expanded', "false");	
                }
                elm.removeClass('mr-0');
                $('.bs-canvas-close', elm).attr('aria-expanded', "false");
                if(bsOverlay.length)
                    bsOverlay.removeClass('show');
                return false;
            });
        });
        </script>
        
	<script>
    $(document).ready(function(){
    	
    	 $('li.active').removeClass('active').removeAttr('aria-current'); 
		  $('a[href="' + location.pathname + '"]').closest('li').addClass('active').attr('aria-current', 'page');   
		  
        $(".innernav").click(function(){
            $(".dropdownNav").addClass("active");
        });
    });
	
	    
</script>

<script>
	// Event delegation: attach to table body
	document.getElementById('supportTicketList').addEventListener('click', function (e) {
	  if (e.target.closest('.view-voucher-details')) {
	    document.getElementById('bs-canvas-right1').style.right = '0';
	    document.getElementById('modal-overlay').style.display = 'block';
	  }
	});

	// Close button
	document.querySelector('.bs-canvas-close').addEventListener('click', function () {
	  document.getElementById('bs-canvas-right1').style.right = '-378px';
	  document.getElementById('modal-overlay').style.display = 'none';
	});

  document.getElementById('modal-overlay').addEventListener('click', function (e) {
    if (e.target.id === 'modal-overlay') {
      document.getElementById('bs-canvas-right1').style.right = '-378px';
      this.style.display = 'none';
    }
  });
  
  document.getElementById('raiseTicket').addEventListener('click', function (e) {
  	  
  	    document.getElementById('bs-canvas-right2').style.right = '0';
  	    document.getElementById('modal-overlay2').style.display = 'block';
  	
  	});
	
	document.querySelector('.bs-canvas-close2').addEventListener('click', function () {
		  document.getElementById('bs-canvas-right2').style.right = '-378px';
		  document.getElementById('modal-overlay2').style.display = 'none';
		});
</script>
		<style>					
			.modal-bulk1 {
		      width: 600px;
		      height: 480px;
		      margin: auto;
		      border-radius: 12px;
		      padding: 0 20px 20px;
		    }
		    .modal-header {
		      border-bottom: 1px solid #dee2e6;
		      justify-content: center;
		    }
		    .modal-title {
		      font-weight: 600;
			 
		    }
		    .form-control {
		      border-radius: 8px;
		      height: 48px;
		    }
		   
		</style>
		
</body>

</html>